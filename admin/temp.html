<?php
// Load new PDO database connector
require_once "../connect.php";  // contains $pdo and session_start()

// Check session login
if (!isset($_SESSION['unamed'])) {
    header("Location: ../index.php");
    exit();
}
?>

<!-- Start Header -->
<?php include "nav.html"; ?>
<!-- End Header -->

<!-- Dashboard counts -->
<div class="notika-status-area">
    <div class="container">
        <div class="row">
        
            <!-- CLASSES -->
            <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12">
                <div class="wb-traffic-inner notika-shadow">
                    <div class="website-traffic-ctn">
                        <h2><span class="counter">
                        <?php
                            $stmt = $pdo->query("SELECT COUNT(classid) FROM lhpclass");
                            echo $stmt->fetchColumn();
                        ?>
                        </span></h2>
                        <a href="mgclass.php"><h4><strong>Classes</strong></h4></a>
                    </div>
                </div>
            </div>

            <!-- STAFF -->
            <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12">
                <div class="wb-traffic-inner notika-shadow">
                    <div class="website-traffic-ctn">
                        <h2><span class="counter">
                        <?php
                            $stmt = $pdo->query("SELECT COUNT(staffid) FROM lhpstaff");
                            echo $stmt->fetchColumn();
                        ?>
                        </span></h2>
                        <a href="mgstaff.php"><h4><strong>Instructors</strong></h4></a>
                    </div>
                </div>
            </div>

            <!-- LEARNERS -->
            <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12">
                <div class="wb-traffic-inner notika-shadow">
                    <div class="website-traffic-ctn">
                        <h2><span class="counter">
                        <?php
                            $stmt = $pdo->query("SELECT COUNT(id) FROM lhpuser");
                            echo $stmt->fetchColumn();
                        ?>
                        </span></h2>
                        <a href="mglearners.php"><h4><strong>Learners</strong></h4></a>
                    </div>
                </div>
            </div>

            <!-- LESSONS -->
            <div class="col-lg-3 col-md-6 col-sm-6 col-xs-12">
                <div class="wb-traffic-inner notika-shadow">
                    <div class="website-traffic-ctn">
                        <h2><span class="counter">
                        <?php
                            $stmt = $pdo->query("SELECT COUNT(noteid) FROM lhpnote");
                            echo $stmt->fetchColumn();
                        ?>
                        </span></h2>
                        <a href="mglesson.php"><h4><strong>Learning Resources</strong></h4></a>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>


<!-- Login Monitor Table -->
<div id="doc" class="data-table-area">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="data-table-list">
                    <div class="basic-tb-hd">
                        <h2>Login Monitor</h2>
                        <p>List of all login attempts</p>
                    </div>

                    <div class="table-responsive">
                        <table id="data-table-basic" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>S/N</th>
                                    <th>IP Address</th>
                                    <th>Username</th>
                                    <th>User Type</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                </tr>
                            </thead>

                            <tbody>
                            <?php
                                $count = 1;
                                $stmt = $pdo->query("SELECT * FROM log ORDER BY udate DESC LIMIT 500");

                                while ($row = $stmt->fetch(PDO::FETCH_OBJ)) {
                                    if ($row->stat == 1)
                                        $show = "Successful Login";
                                    elseif ($row->stat == 2)
                                        $show = "Failed! Learner Account Deactivated";
                                    elseif ($row->stat == 3)
                                        $show = "Failed! Incorrect Password";
                                    elseif ($row->stat == 4)
                                        $show = "Failed! Wrong Username";
                            ?>
                                <tr>
                                    <td><?= $count++ ?></td>
                                    <td><?= htmlspecialchars($row->uip) ?></td>
                                    <td><?= htmlspecialchars($row->uname) ?></td>
                                    <td><?= htmlspecialchars($row->utype) ?></td>
                                    <td><?= $show ?></td>
                                    <td><?= $row->udate ?></td>
                                </tr>
                            <?php } ?>
                            </tbody>

                            <tfoot>
                                <tr>
                                    <th>S/N</th>
                                    <th>IP Address</th>
                                    <th>Username</th>
                                    <th>User Type</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>


<?php include "foot.html"; ?>

</body>
</html>
